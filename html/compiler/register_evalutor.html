<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>寄存求值器</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Wu, Shanliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="content">
<h1 class="title">寄存求值器</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org88906f6">内存管理</a>
<ul>
<li><a href="#org9da2204">向量模拟内存</a>
<ul>
<li><a href="#orgc947912">Scheme 序对的表示</a></li>
<li><a href="#org2efd4e9">基本表操作实现</a></li>
<li><a href="#org8b2a60e">栈实现</a></li>
</ul>
</li>
<li><a href="#org356076d">垃圾回收机制</a></li>
</ul>
</li>
</ul>
</div>
</div>
<p>
用 <span class="underline">寄存器语言</span> 实现 <span class="underline">求值器</span> 是低层次的工作，能揭示 Scheme 程序解释中的许多前面无法涉及的控制细节，包括：
</p>
<ul class="org-ul">
<li>过程调用时 <b>参数值的传递</b> 和 <b>结果返回</b></li>
<li><b>尾递归</b> 的实现</li>
</ul>

<pre class="example">
  这里还可以继续用前面求值器的基本数据结构和语法过程

  完全可以用更基本的操作实现，做出一个可以直接对应到常规高级语言或常规机器语言的求值器
</pre>
<div id="outline-container-org88906f6" class="outline-2">
<h2 id="org88906f6">内存管理</h2>
<div class="outline-text-2" id="text-org88906f6">
<p>
为简化讨论，先假定有一个 <b>表结构</b> 的内存， <span class="underline">表操作</span> 都是基本操作
</p>
<pre class="example">
    这种抽象使人能集中精力考虑求值器的关键特征

    但表存储是 Scheme 的基础，不理解它，对系统的理解有缺陷

    为完整起见，下面先讨论怎样在常规的内存上实现表存储结构
</pre>

<p>
表结构的实现要考虑两个问题：
</p>
<ol class="org-ol">
<li>表示： 如何只用典型计算机的 <span class="underline">存储单元</span> 和 <span class="underline">寻址</span> 功能，把 <b>序对</b> 的 <span class="underline">指针盒子</span> 结构映射到常规计算机的连续内存</li>
<li>实现： 把管理内存的工作实现为一个计算过程</li>
</ol>
<pre class="example">
    要支持 Scheme 程序的执行，系统必须能随时创建对象，包括：

    程序里用的序对和其他对象
    支持程序执行而隐式创建的对象，如环境、框架和参数表等

    程序执行中可能创建很多对象，创建的数量并没有限制
</pre>

<p>
如果计算机的存储无穷大，就可以创建任意多个对象。但 <b>实际计算机的存储总有限</b> ，因此需要有一种自动机制：利用有限的存储制造一种无穷假象， <b>当已分配的对象不再需要时自动将其回收</b> 。这就是 <span class="underline">垃圾回收</span> 
</p>
</div>
<div id="outline-container-org9da2204" class="outline-3">
<h3 id="org9da2204">向量模拟内存</h3>
<div class="outline-text-3" id="text-org9da2204">
<p>
常规计算机的内存是一串很小的单元：
</p>
<ul class="org-ul">
<li>每个单元里可保存一点信息，有一个唯一的名字称为 <span class="underline">地址</span></li>
<li>典型操作：
<ul class="org-ul">
<li><b>读特定单元的内容</b></li>
<li><b>给特定单元赋新值</b></li>
</ul></li>
<li>通过 <span class="underline">地址增量</span> 操作可以 <b>顺序地访问</b> 一批单元</li>
</ul>
<pre class="example">
     有些操作（指针）要求把地址作为数据，将其存入内存单元，或在寄存器里对地址做各种运算

     “表处理”是指针运算的典型实例
</pre>

<p>
为模拟计算机内存，下面介绍一种新数据结构称为 <b>向量</b> 。向量是一种复合数据对象，其元素可通过 <b>整数下标</b> 访问，访问所需时间与元素位置无关。用两个过程描述向量操作：
</p>
<ol class="org-ol">
<li><span class="underline">(vector-ref &lt;vector&gt; &lt;n&gt;)</span> : 返回向量里的第 n 个元素</li>
<li><span class="underline">(vector-set! &lt;vector&gt; &lt;n&gt; &lt;value&gt;)</span> : 向量里第 n 个元素赋值为 &lt;v&gt;</li>
</ol>

<p>
对计算机内存单元的访问可以通过 <b>地址算术</b> 实现（用 <span class="underline">向量基址</span> 加 <span class="underline">特定元素的偏移量</span> ） 
</p>

<pre class="example">
     新型计算机内存已很难用简单向量表现

     它们有复杂的缓存系统，复杂的缓存一致性算法
     多核的加入使情况进一步复杂化，理解其细节行为变得更加困难，需要通过复杂的模拟

     但这种抽象模型仍反映了它的一部分情况和性质
</pre>
</div>
<div id="outline-container-orgc947912" class="outline-4">
<h4 id="orgc947912">Scheme 序对的表示</h4>
<div class="outline-text-4" id="text-orgc947912">
<p>
用向量实现表存储器所需的序对结构：
</p>
<ol class="org-ol">
<li>设想两个向量 <span class="underline">the-cars</span> 和 <span class="underline">the-cdrs</span></li>
<li><span class="underline">指向序对的指针</span> 用 <b>向量的下标</b> 表示， <span class="underline">序对的 car</span> 就是 <span class="underline">向量 the-cars</span> 里 <b>特定元素的内容</b> ，cdr 类似</li>
</ol>


<div class="figure">
<p><img src="pic/pair-representaion.gif" alt="pair-representaion.gif" width="60%" /> 
</p>
</div>

<p>
非序对数据用 <b>带类型指针</b> 表示。为此要扩充指针增加类型信息：
</p>
<ul class="org-ul">
<li>可以在指针里加 <span class="underline">标志位</span></li>
<li>如果有带标志位的硬件机器，也可利用地址中不用的位</li>
</ul>

<pre class="example">
eq? 就是比较指向序对的指针的值是否相同
</pre>
<p>
<b>符号</b> 用 <span class="underline">带类型指针</span> 表示：
</p>
<ul class="org-ul">
<li>实际的 Scheme 系统里有一个 <b>符号表</b> ，称为 <span class="underline">对象表</span> 
<ul class="org-ul">
<li>读入遇到新符号时 <span class="underline">创建表项</span> ，取得 <span class="underline">符号指针</span></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org2efd4e9" class="outline-4">
<h4 id="org2efd4e9">基本表操作实现</h4>
<div class="outline-text-4" id="text-org2efd4e9">
<pre class="example">
      有了序对的上述表示，基本表操作都可以“代换”为向量操作
</pre>
<p>
下面假定有 <span class="underline">向量访问</span> 和 <span class="underline">赋值</span> ， <span class="underline">指针算术运算</span> ： 
</p>

<p>
寄存器机器支持的 <span class="underline">赋值</span>  指令 ：
</p>

<pre class="example">
;;; reg2 寄存器中存放了一个序对在向量数组的下标，把这个序对的car内容放入到 reg1 寄存器
(assign &lt;reg1&gt; (op car) (reg &lt;reg2&gt;))

;;; reg2 寄存器中存放了一个序对在向量数组的下标，把这个序对的car内容放入到 reg1 寄存器
(assign &lt;reg1&gt; (op cdr) (reg &lt;reg2&gt;))
</pre>

<p>
可以实现为： 
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#31867;&#20284;&#20110;&#35843;&#29992; (vector-ref the-cars reg2)</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">the-cars &#23492;&#23384;&#22120;:  cars &#21521;&#37327;&#30340;&#22522;&#30784;&#22320;&#22336;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg2 &#23492;&#23384;&#22120;: &#24207;&#23545;&#22312;&#21521;&#37327;&#25968;&#32452;&#30340;&#19979;&#26631;</span>
<span style="color: #696969;">(</span>assign <span style="color: #98f5ff;">&lt;reg1&gt;</span> <span style="color: #696969;">(</span>op vector-ref<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg2&gt;</span><span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#31867;&#20284;&#20110;&#35843;&#29992; (vector-ref the-cdrs reg2)</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">the-cdrs &#23492;&#23384;&#22120;:  cdrs &#21521;&#37327;&#30340;&#22522;&#30784;&#22320;&#22336;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg2 &#23492;&#23384;&#22120;: &#24207;&#23545;&#22312;&#21521;&#37327;&#25968;&#32452;&#30340;&#19979;&#26631;</span>
<span style="color: #696969;">(</span>assign <span style="color: #98f5ff;">&lt;reg1&gt;</span> <span style="color: #696969;">(</span>op vector-ref<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg2&gt;</span><span style="color: #696969;">))</span>
</pre>
</div>

<p>
寄存器机器的 <span class="underline">执行</span> 指令：
</p>

<pre class="example">
;;; 把 reg1 寄存器的内容 赋值给 reg2寄存器对应的序对的car上
(perform (op set-car!) (reg &lt;reg1&gt;) (reg &lt;reg2&gt;))

;;; 把 reg1 寄存器的内容 赋值给 reg2寄存器对应的序对的cdr上
(perform (op set-cdr!) (reg &lt;reg1&gt;) (reg &lt;reg2&gt;))
</pre>

<p>
实现为： 
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#36825;&#37324;&#35843;&#29992; (vector-set! the-cars reg2 reg1)</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">the-cars &#23492;&#23384;&#22120;&#65306;cars&#21521;&#37327;&#30340;&#22522;&#30784;&#22320;&#22336;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg1 &#23492;&#23384;&#22120;: &#36171;&#20540;&#20869;&#23481;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg2 &#23492;&#23384;&#22120;: &#24207;&#23545;&#19979;&#26631;</span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg1&gt;</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg2&gt;</span><span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#36825;&#37324;&#35843;&#29992; (vector-set! the-cdrs reg2 reg1)</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">the-cdrs &#23492;&#23384;&#22120;&#65306;cdrs&#21521;&#37327;&#30340;&#22522;&#30784;&#22320;&#22336;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg1 &#23492;&#23384;&#22120;: &#36171;&#20540;&#20869;&#23481;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg2 &#23492;&#23384;&#22120;: &#24207;&#23545;&#19979;&#26631;</span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg1&gt;</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg2&gt;</span><span style="color: #696969;">))</span>
</pre>
</div>

<p>
执行 cons 时 <b>创建</b> 新序对单元，分别存入相应的 <span class="underline">car</span> 和 <span class="underline">cdr</span> 。假定特殊寄存器 <b>free</b>  总指向一个空闲下标，增加其值可得到下一可用下标（要
求空闲位置连续）。这时 <span class="underline">cons</span> 指令 可以实现为： 
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">(vector-set! the-cars free reg2) </span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cars<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg free<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg2&gt;</span><span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">(vector-set! the-cdrs free reg3) </span>
<span style="color: #696969;">(</span>perform
 <span style="color: #696969;">(</span>op vector-set!<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-cdrs<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg free<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg3&gt;</span><span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">free &#36171;&#20540;&#32473; reg1  </span>
<span style="color: #696969;">(</span>assign <span style="color: #98f5ff;">&lt;reg1&gt;</span> <span style="color: #696969;">(</span>reg free<span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">free &#30340;&#20540;&#22686;&#21152; 1 </span>
<span style="color: #696969;">(</span>assign free <span style="color: #696969;">(</span>op +<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg free<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>const 1<span style="color: #696969;">))</span>
</pre>
</div>

<p>
<span class="underline">eq?</span> 操作只是简单比较 reg1 和 reg2 的值是否相同（向量中的下标值是否相同） 
</p>
<pre class="example">
(op eq?) (reg &lt;reg1&gt;) (reg &lt;reg2&gt;) 
</pre>

<p>
<span class="underline">pair?</span> ,  <span class="underline">null?</span> ,  <span class="underline">symbol?</span> ,  <span class="underline">number?</span> 等操作还必须检查 <b>指针的类型</b> 是否相同
</p>
</div>
</div>
<div id="outline-container-org8b2a60e" class="outline-4">
<h4 id="org8b2a60e">栈实现</h4>
<div class="outline-text-4" id="text-org8b2a60e">
<p>
寄存器机器需要的 <span class="underline">栈</span> 可以用 <b>表</b> 模拟， <span class="underline">栈头序对</span> 在 <span class="underline">向量中的下标</span> （栈顶地址）用一个特殊寄存器 <b>the-stack</b> 来存放
</p>

<pre class="example">
      这些操作都可以基于前面使用向量模拟的内存

      实际系统里考虑实现效率，常另用一个向量来实现栈，压栈和出栈操作用改变栈顶寄存器的指针值来实现
</pre>

<p>
压栈    <span class="underline">(save &lt;reg&gt;)</span> 可以实现为： 
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">(cons reg the-stack) </span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">reg &#23492;&#23384;&#22120;: &#24207;&#23545;&#30340;&#19979;&#26631;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">the stack &#23492;&#23384;&#22120;: &#26632;&#39030;&#23545;&#24212;&#30340;&#19979;&#26631;</span>
<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">cons&#36820;&#22238;&#30340;&#26032;&#30340;&#24207;&#23545;&#30340;&#19979;&#26631;&#20250;&#34987;&#36171;&#20540;&#32473; the-stack &#23492;&#23384;&#22120;&#65292;&#36825;&#30456;&#24403;&#20110;&#20462;&#25913;&#20102;&#26632;&#39030;&#25351;&#38024;</span>
<span style="color: #696969;">(</span>assign the-stack <span style="color: #696969;">(</span>op cons<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg <span style="color: #98f5ff;">&lt;reg&gt;</span><span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-stack<span style="color: #696969;">))</span>
</pre>
</div>

<p>
出栈    <span class="underline">(restore &lt;reg&gt;)</span> 实现为： 
</p>

<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#20174;&#26632;&#39030;&#35835;&#21462;&#20540;</span>
<span style="color: #696969;">(</span>assign <span style="color: #98f5ff;">&lt;reg&gt;</span> <span style="color: #696969;">(</span>op car<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-stack<span style="color: #696969;">))</span>

<span style="color: #5f9ea0; font-style: italic;">;;; </span><span style="color: #5f9ea0; font-style: italic;">&#8220;&#26632;&#39030;&#23492;&#23384;&#22120;&#8221;&#36171;&#20540;&#20026;&#8220;&#24403;&#21069;&#26632;&#39030;&#24207;&#23545;&#30340;cdr&#8221;&#30340;&#8220;&#21521;&#37327;&#19979;&#26631;&#8221;</span>
<span style="color: #696969;">(</span>assign the-stack <span style="color: #696969;">(</span>op cdr<span style="color: #696969;">)</span> <span style="color: #696969;">(</span>reg the-stack<span style="color: #696969;">))</span>
</pre>
</div>

<p>
初始化栈    <span class="underline">(perform (op initialize-stack))</span> 实现为：
</p>
<div class="org-src-container">
<pre class="src src-scheme"><span style="color: #696969;">(</span>assign the-stack <span style="color: #696969;">(</span>const <span style="color: #696969;">()))</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org356076d" class="outline-3">
<h3 id="org356076d">垃圾回收机制</h3>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
