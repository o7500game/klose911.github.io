<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<title>ICMP控制报文协议</title>
<meta  http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta  name="generator" content="Org-mode" />
<meta  name="author" content="Wu, Shanliang" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center; }
  .todo   { font-family: monospace; color: red; }
  .done   { color: green; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  pre.src-sh:before    { content: 'sh'; }
  pre.src-bash:before  { content: 'sh'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-R:before     { content: 'R'; }
  pre.src-perl:before  { content: 'Perl'; }
  pre.src-java:before  { content: 'Java'; }
  pre.src-sql:before   { content: 'SQL'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.right  { text-align: center;  }
  th.left   { text-align: center;   }
  th.center { text-align: center; }
  td.right  { text-align: right;  }
  td.left   { text-align: left;   }
  td.center { text-align: center; }
  dt { font-weight: bold; }
  .footpara:nth-child(2) { display: inline; }
  .footpara { display: block; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  /*]]>*/-->
</style>
<link rel="stylesheet" type="text/css" href="css/main.css" />
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2013 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="rarp.html"> UP </a>
 |
 <a accesskey="H" href="tii.html"> HOME </a>
</div><div id="content">
<h1 class="title">ICMP控制报文协议</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#sec-1">ICMP协议</a>
<ul>
<li><a href="#sec-1-1">报文</a>
<ul>
<li><a href="#sec-1-1-1">报文类型</a></li>
<li><a href="#sec-1-1-2">地址掩码请求与应答</a>
<ul>
<li><a href="#sec-1-1-2-1">广播地址掩码请求</a></li>
<li><a href="#sec-1-1-2-2">向本机发送地址掩码请求</a></li>
</ul>
</li>
<li><a href="#sec-1-1-3">时间戳请求与应答</a></li>
<li><a href="#sec-1-1-4">端口不可达</a></li>
</ul>
</li>
<li><a href="#sec-1-2">ICMP报文的4.4BSD处理</a></li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">ICMP协议</h2>
<div class="outline-text-2" id="text-1">
<p>
ICMP经常被认为是IP层的一个组成部分。它传递差错报文以及其他需要注意的信息。ICMP报文通常被IP层或更高层协议（TCP或UDP）使用。一些ICMP报文把差错报文返回给用户进程。ICMP报文是在IP数据报内部被传输的，如图6-1所示：
</p>


<div class="figure">
<p><img src="pic/icmp-encapsulation.png" alt="icmp-encapsulation.png" width="40%" />
</p>
</div>
</div>

<div id="outline-container-sec-1-1" class="outline-3">
<h3 id="sec-1-1">报文</h3>
<div class="outline-text-3" id="text-1-1">
<p>
ICMP报文的格式如图6-2所示：
</p>


<div class="figure">
<p><img src="pic/icmp-packet.png" alt="icmp-packet.png" width="40%" />
</p>
</div>

<p>
所有报文的前4个字节都是一样的：
</p>
<ul class="org-ul">
<li>类型字段可以有15个不同的值，以描述特定类型的ICMP报文。某些ICMP报文还使用代码字段的值来进一步描述不同的条件
</li>
<li>检验和字段覆盖整个ICMP报文。使用的算法与在3.2节中介绍的IP首部检验和算法相同。ICMP的检验和是必需的
</li>
</ul>

<p>
剩下的其他字节则互不相同 
</p>
</div>

<div id="outline-container-sec-1-1-1" class="outline-4">
<h4 id="sec-1-1-1">报文类型</h4>
<div class="outline-text-4" id="text-1-1-1">
<p>
各种类型的ICMP报文如下表所示，不同类型由报文中的类型字段和代码字段来共同决定：
</p>

<table border="1" cellspacing="0" cellpadding="6" rules="groups" frame="boader">
<caption class="t-above"><span class="table-number">Table 1:</span> ICMP报文类型</caption>

<colgroup>
<col  class="right" />

<col  class="right" />

<col  class="left" />

<col  class="left" />

<col  class="left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="right">类型</th>
<th scope="col" class="right">代码</th>
<th scope="col" class="left">描述</th>
<th scope="col" class="left">查询</th>
<th scope="col" class="left">差错</th>
</tr>
</thead>
<tbody>
<tr>
<td class="right">0</td>
<td class="right">0</td>
<td class="left">回显应答</td>
<td class="left">•</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">3</td>
<td class="right">&#xa0;</td>
<td class="left">目的不可达</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">0</td>
<td class="left">网络不可达</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">1</td>
<td class="left">主机不可达</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">2</td>
<td class="left">协议不可达</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">3</td>
<td class="left">端口不可达</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">4</td>
<td class="left">需要进行分片但设置了不分片比特</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">5</td>
<td class="left">源站选路失败</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">6</td>
<td class="left">目的网络不认识</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">7</td>
<td class="left">目的主机不认识</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">8</td>
<td class="left">源主机被隔离(作废不用)</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">9</td>
<td class="left">目的网络被强制禁止</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">10</td>
<td class="left">目的主机被强制禁止</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">11</td>
<td class="left">由于服务类型TOS，网络不可达</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">12</td>
<td class="left">由于服务类型TOS，主机不可达</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">13</td>
<td class="left">由于过滤，通信被强制禁止</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">14</td>
<td class="left">主机越权</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">15</td>
<td class="left">优先权中止生效</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">4</td>
<td class="right">0</td>
<td class="left">源端被关闭(基本流控制)</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">5</td>
<td class="right">&#xa0;</td>
<td class="left">重定向</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">0</td>
<td class="left">对网络重定向</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">1</td>
<td class="left">对主机重定向</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">2</td>
<td class="left">对服务类型和网络重定向</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">3</td>
<td class="left">对服务类型和主机重定向</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">8</td>
<td class="right">0</td>
<td class="left">请求回显</td>
<td class="left">•</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">9</td>
<td class="right">0</td>
<td class="left">路由器通告</td>
<td class="left">•</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">10</td>
<td class="right">0</td>
<td class="left">路由器请求</td>
<td class="left">•</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">11</td>
<td class="right">&#xa0;</td>
<td class="left">超时</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">0</td>
<td class="left">传输期间生存时间为0</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">1</td>
<td class="left">在数据报组装期间生存时间为0</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">12</td>
<td class="right">&#xa0;</td>
<td class="left">参数问题</td>
<td class="left">&#xa0;</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">0</td>
<td class="left">坏的IP首部(包括各种差错)</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>

<tr>
<td class="right">&#xa0;</td>
<td class="right">1</td>
<td class="left">缺少必需的选项</td>
<td class="left">&#xa0;</td>
<td class="left">•</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">13</td>
<td class="right">0</td>
<td class="left">时间戳请求</td>
<td class="left">•</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">14</td>
<td class="right">0</td>
<td class="left">时间戳应答</td>
<td class="left">•</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">15</td>
<td class="right">0</td>
<td class="left">信息请求(作废不用)</td>
<td class="left">•</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">16</td>
<td class="right">0</td>
<td class="left">信息应答(作废不用)</td>
<td class="left">•</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
<tbody>
<tr>
<td class="right">17</td>
<td class="right">0</td>
<td class="left">地址掩码请求</td>
<td class="left">•</td>
<td class="left">&#xa0;</td>
</tr>

<tr>
<td class="right">18</td>
<td class="right">0</td>
<td class="left">地址掩码应答</td>
<td class="left">•</td>
<td class="left">&#xa0;</td>
</tr>
</tbody>
</table>

<p>
表中的最后两列表明ICMP报文是一份查询报文还是一份差错报文。因为对ICMP差错报文有时需要作特殊处理，所以需要对它们进行区分。例如，在对ICMP差错报文进行响应时，永远不会生成另一份ICMP差错报文（如果没有这个限制规则，可能会遇到一个差错产生另一个差错的情况，而差错再产生差错，这样会无休止地循环下去） 
</p>

<p>
当发送一份ICMP差错报文时，报文始终包含IP的首部和产生ICMP差错报文的IP数据报的前8个字节。这样，接收ICMP差错报文的模块就会把它与某个特定的协议（根据IP数据报首部中的协议字段来判断）和用户进程（根据包含在IP数据报前8个字节中的TCP或UDP报文首部中的TCP或UDP端口号来判断）联系起来
</p>

<p>
下面各种情况都不会导致产生ICMP差错报文：
</p>
<ul class="org-ul">
<li>ICMP差错报文（但是ICMP查询报文可能会产生ICMP差错报文）
</li>
<li>目的地址是广播地址或多播地址的IP数据报
</li>
<li>作为链路层广播的数据报
</li>
<li>不是IP分片的第一片
</li>
<li>源地址不是单个主机的数据报，例如源地址不能为零地址、环回地址、广播地址或多播地址
</li>
</ul>

<p>
这些规则是为了防止过去允许ICMP差错报文对广播分组响应所带来的广播风暴
</p>
</div>
</div>

<div id="outline-container-sec-1-1-2" class="outline-4">
<h4 id="sec-1-1-2">地址掩码请求与应答</h4>
<div class="outline-text-4" id="text-1-1-2">
<p>
ICMP地址掩码请求用于无盘系统在引导过程中获取自己的子网掩码。系统广播它的ICMP请求报文（这一过程与无盘系统在引导过程中用RARP获取IP地址是类似的，无盘系统获取子网掩码的另一个方法是BOOTP协议）。ICMP地址掩码请求和应答报文的格式如图6-4所示：
</p>


<div class="figure">
<p><img src="pic/icmp-network-mask.png" alt="icmp-network-mask.png" width="70%" />
</p>
</div>

<p>
ICMP报文中的标识符和序列号字段由发送端任意选择设定，这些值在应答中将被返回。这样，发送端就可以把应答与请求进行匹配
</p>
</div>

<div id="outline-container-sec-1-1-2-1" class="outline-5">
<h5 id="sec-1-1-2-1">广播地址掩码请求</h5>
<div class="outline-text-5" id="text-1-1-2-1">
<p>
可以写一个简单的程序（命名为icmpaddrmask），它发送一份ICMP地址掩码请求报文，然后打印出所有的应答。由于一般是把请求报文发往广播地址，这里也这样做，其中目的地址（140.252.13.63）是子网140.252.13.32的广播地址：
</p>
<div class="org-src-container">

<pre class="src src-sh">sun $ icmpaddrmask 140.252.13.63
</pre>
</div>

<pre class="example">
received mask = ffffffe0, from 140.252.13.3 来自 本机
received mask = ffffffe0, from 140.252.13.5 来自 bsdi
received mask = ffff0000, from 140.252.13.4 来自 svr4
</pre>

<p>
首先在输出中注意到的是，从svr4返回的子网掩码是错的。显然，尽管svr4接口已经设置了正确的子网掩码，但是svr4还是返回了一个普通的B类地址掩码，就好像子网并不存在一样：
</p>
<div class="org-src-container">

<pre class="src src-sh">svr4 $ ifconfig emd0
</pre>
</div>

<pre class="example">
emd0: flags=23&lt;UP,BROADCAST,NOTRAILERS&gt;
      inet 140.252.13.34 netmask ffffffe0 broadcast 140.252.13.63
</pre>

<p>
由此可见svr4处理ICMP地址掩码请求过程存在差错。用tcpdump命令来查看主机bsdi上的情况，输出如图6-5所示：
</p>

<div class="figure">
<p><img src="pic/icmp-netmask-tcpdump.png" alt="icmp-netmask-tcpdump.png" width="70%" />
</p>
</div>

<ul class="org-ul">
<li>尽管在线路上什么也看不见，但是发送主机sun也能接收到ICMP应答（“来自本机”的输出行）。这是广播的一般特性：发送主机也能通过某种内部环回机制收到一份广播报文拷贝。由于术语“广播”的定义是指局域网上的所有主机，因此它必须包括发送主机在内（当以太网驱动程序识别出目的地址是广播地址后，它就把分组送到网络上，同时传一份拷贝到环回接口）
</li>
<li>bsdi广播应答，而svr4却只把应答传给请求主机。通常，应答地址必须是单播地址，除非请求端的源IP地址是0.0.0.0。本例不属于这种情况，因此，把应答发送到广播地址是BSD的一个内部差错
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-1-1-2-2" class="outline-5">
<h5 id="sec-1-1-2-2">向本机发送地址掩码请求</h5>
<div class="outline-text-5" id="text-1-1-2-2">
<p>
向本机IP地址和环回地址分别发送地址掩码请求：
</p>
<div class="org-src-container">

<pre class="src src-sh">sun $ icmpaddrmask sun
</pre>
</div>

<pre class="example">
received mask= ff000000, from 140.252.13.33
</pre>

<div class="org-src-container">

<pre class="src src-sh">sun $ icmpaddrmask localhost
</pre>
</div>

<pre class="example">
received mask= ff000000, from 127.0.0.1
</pre>
<p>
上述两种情况下返回的地址掩码对应的都是环回地址，即A类地址127.0.0.1。ICMP地址掩码应答必须是收到请求接口的子网掩码（这是因为多接口主机每个接口有不同的子网掩码），因此两种情况下地址掩码请求都来自于环回接口。所以说发送给本机IP地址的数据报（140.252.12.33）实际上是送到环回接口
</p>
</div>
</div>
</div>

<div id="outline-container-sec-1-1-3" class="outline-4">
<h4 id="sec-1-1-3">时间戳请求与应答</h4>
</div>

<div id="outline-container-sec-1-1-4" class="outline-4">
<h4 id="sec-1-1-4">端口不可达</h4>
</div>
</div>

<div id="outline-container-sec-1-2" class="outline-3">
<h3 id="sec-1-2">ICMP报文的4.4BSD处理</h3>
</div>
</div>
</div>
<div id="postamble" class="status">

		  <br/>
		  <div class='ds-thread'></div>
		  <script>
		  var duoshuoQuery = {short_name:'klose911'};
		  (function() {
					  var dsThread = document.getElementsByClassName('ds-thread')[0];
					  dsThread.setAttribute('data-thread-key', document.title);
					  dsThread.setAttribute('data-title', document.title);
					  dsThread.setAttribute('data-url', window.location.href);
					  var ds = document.createElement('script');
					  ds.type = 'text/javascript';ds.async = true;
					  ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
					  ds.charset = 'UTF-8';
					  (document.getElementsByTagName('head')[0] 
						|| document.getElementsByTagName('body')[0]).appendChild(ds);
					  })();
		  </script>
		  <script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
			m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
			})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		  ga('create', 'UA-90850421-1', 'auto');
		  ga('send', 'pageview');
		  </script>
</div>
</body>
</html>
